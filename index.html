<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video YouTube với Phụ đề, TTS và Từ vựng (Hoàn hảo)</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            text-align: center;
            transition: all 0.3s ease;
        }
        .container {
            margin-top: 20px;
        }
        input, button {
            margin: 5px;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }
        #video-container {
            margin-top: 20px;
            position: relative;
            padding-bottom: 56.25%; /* 16:9 ratio */
            height: 0;
            overflow: hidden;
        }
        #video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #subtitle-display {
            font-size: 18px;
            margin-top: 10px;
            color: #333;
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        #subtitle-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            margin-top: 20px;
            text-align: left;
            padding: 10px;
        }
        .subtitle-item {
            padding: 5px;
            cursor: pointer;
        }
        .subtitle-item:hover {
            background-color: #f0f0f0;
        }
        .subtitle-item.active {
            background-color: #d0e8ff;
        }
        #tts-speed-container, #tts-language-container {
            margin-top: 10px;
        }
        .korean-word {
            color: #0066cc;
            cursor: pointer;
        }
        .korean-word:hover {
            text-decoration: underline;
        }
        .vietnamese {
            color: #cc0000;
        }
        .subtitle-line {
            padding: 5px 0;
        }
        .subtitle-line.current {
            background-color: #d0e8ff;
            font-weight: bold;
        }
        #history-list, #vocab-list, #favorite-subtitles {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            margin-top: 20px;
            text-align: left;
            padding: 10px;
        }
        .history-item, .vocab-item {
            padding: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item:hover, .vocab-item:hover {
            background-color: #f0f0f0;
        }
        .history-item button, .vocab-item button {
            margin-left: 10px;
            padding: 2px 5px;
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .history-item button:hover, .vocab-item button:hover {
            background-color: #cc0000;
        }
        .volume-container {
            margin: 10px 0;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #subtitle-link {
            margin-top: 10px;
            color: #0066cc;
            text-decoration: none;
        }
        #subtitle-link:hover {
            text-decoration: underline;
        }
        .control-buttons {
            margin: 10px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .rewind-btn {
            background-color: #4CAF50;
            color: white;
        }
        .rewind-btn:hover {
            background-color: #45a049;
        }
        .test-tts-btn {
            background-color: #ff9800;
            color: white;
        }
        .test-tts-btn:hover {
            background-color: #e68a00;
        }
        .auto-sub-btn {
            background-color: #2196F3;
            color: white;
        }
        .auto-sub-btn:hover {
            background-color: #1976D2;
        }
        .repeat-btn {
            background-color: #9c27b0;
            color: white;
        }
        .repeat-btn:hover {
            background-color: #7b1fa2;
        }
        .translate-srt-btn {
            background-color: #f44336;
            color: white;
        }
        .translate-srt-btn:hover {
            background-color: #d32f2f;
        }
        #translation-progress {
            margin-top: 10px;
        }
        #progress-text {
            margin-left: 10px;
        }
        @media (max-width: 600px) {
            body {
                margin: 10px;
            }
            input, button {
                padding: 6px;
                font-size: 14px;
            }
            #subtitle-display {
                font-size: 16px;
            }
            .control-buttons {
                flex-direction: column;
            }
        }
        .korean-word.clickable {
            color: #0066cc;
            cursor: pointer;
            padding: 5px;
            display: inline-block;
        }
        .korean-word.clickable:hover {
            text-decoration: underline;
            background-color: #f0f0f0;
        }
        .vietnamese.translation {
            color: #cc0000;
            margin-left: 10px;
        }
        .vocab-item-naver {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .inline-meaning {
            font-size: 12px;
            color: #888;
            margin-left: 4px;
        }
        .korean-word.learned {
            background-color: #fff3cd;
            border-bottom: 1px dotted #ffa500;
            padding: 2px 4px;
            border-radius: 3px;
            cursor: pointer;
        }
        .clickable-vocab {
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .clickable-vocab:hover {
            background-color: #f0f0f0;
            cursor: pointer;
        }
        .upcoming-vocab-item {
            padding: 8px;
            margin: 5px 0;
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            display: flex;
            justify-content: space-between;
        }
        .upcoming-vocab-item-active {
            background-color: #ffeb95;
            border-color: #ffc107;
            font-weight: bold;
        }
        .upcoming-vocab-korean {
            font-weight: bold;
            color: #0066cc;
        }
        .upcoming-vocab-meaning {
            color: #cc0000;
            margin-left: 10px;
        }
        .upcoming-vocab-time {
            color: #666;
            font-size: 0.9em;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <h1>Video YouTube với Phụ đề, TTS và Từ vựng (Hoàn hảo)</h1>
    <div class="container">
        <input type="text" id="video-url" placeholder="Nhập link YouTube (ví dụ: https://www.youtube.com/watch?v=dQw4w9WgXcQ)">
        <button onclick="loadVideo()">Tải Video</button>
        <div id="subtitle-link-container" style="display:none;">
            <a id="subtitle-link" target="_blank">Tải phụ đề từ subtitle.to</a>
        </div>
        <br>
        <input type="file" id="subtitle-file" accept=".srt">
        <button onclick="loadSubtitles()">Tải Phụ đề</button>
        <button class="auto-sub-btn" onclick="loadAutoSubtitles()">Tải Phụ đề Tự động</button>
        <br>
        <div class="control-buttons">
            <button onclick="startReading()">Bắt đầu Đọc</button>
            <button onclick="stopReading()">Dừng TTS</button>
            <button class="rewind-btn" onclick="rewindSubtitle()">Lùi 5 giây</button>
            <button class="test-tts-btn" onclick="testTTS()">Kiểm tra TTS</button>
            <button class="repeat-btn" onclick="toggleRepeat()">Lặp Phụ đề (Bật/Tắt)</button>
            <button onclick="saveState()">Lưu Trạng Thái</button>
            <button class="translate-srt-btn" onclick="translateSRT()">Dịch Phụ đề</button>
        </div>
        <input type="file" id="state-file" accept=".json">
        <button onclick="loadState()">Tải Trạng Thái</button>
        <div id="tts-speed-container">
            <label for="tts-speed">Tốc độ TTS: </label>
            <input type="range" id="tts-speed" min="0.5" max="2.5" step="0.1" value="1.5" onchange="updateTTSSpeed(this.value)">
            <span id="speed-value">1.5</span>
        </div>
        <div id="tts-language-container">
            <label for="tts-language">Ngôn ngữ TTS: </label>
            <select id="tts-language" onchange="updateTTSLanguage(this.value)">
                <option value="vi-VN">Tiếng Việt</option>
                <option value="ko-KR">Tiếng Hàn</option>
            </select>
        </div>
        <div style="margin-top:10px; display: flex; align-items: center; justify-content: center; gap: 5px;">
            <label for="subtitle-offset">Lệch thời gian phụ đề (giây): </label>
            <button onclick="toggleNegativeOffset()">-</button>
            <input type="number" id="subtitle-offset" min="-5" max="5" step="0.1" value="0" style="width: 70px; text-align: center;" onchange="updateSubtitleOffset(this.value)">
            <span id="offset-value">0.0</span>
            <button onclick="applyOffsetToSubtitles()">Áp dụng lệch vĩnh viễn</button>
        </div>
        <div class="volume-container">
            <div class="volume-control">
                <label for="video-volume">Âm lượng Video: </label>
                <input type="range" id="video-volume" min="0" max="100" value="100" onchange="updateVideoVolume(this.value)">
                <span id="video-volume-value">100</span>
            </div>
            <div class="volume-control">
                <label for="tts-volume">Âm lượng TTS: </label>
                <input type="range" id="tts-volume" min="0" max="1" step="0.1" value="1" onchange="updateTTSVolume(this.value)">
                <span id="tts-volume-value">1.0</span>
            </div>
        </div>
        <div style="margin-top: 20px; border: 1px solid #ccc; padding: 10px;">
            <h3>Cảnh báo từ vựng sắp xuất hiện</h3>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="vocab-warning-time">Hiển thị trước (giây):</label>
                <input type="number" id="vocab-warning-time" min="1" max="30" value="5" style="width: 60px;">
                <button onclick="toggleVocabWarning()">Bật/Tắt</button>
                <button id="auto-pause-button" onclick="toggleAutoPause()">Tạm dừng tự động (Tắt)</button>
            </div>
            <div id="upcoming-vocab-display" style="margin-top: 10px; min-height: 50px; border: 1px dashed #ccc; padding: 10px;"></div>
        </div>
        <div id="translation-progress" style="display: none;">
            <progress id="progress-bar" value="0" max="100"></progress>
            <span id="progress-text">Đang dịch... 0%</span>
        </div>
    </div>
    <div id="video-container">
        <iframe id="youtube-video" frameborder="0" allowfullscreen></iframe>
    </div>
    <div id="subtitle-display"></div>
    <div id="subtitle-list"></div>
    <h3>Lịch sử xem</h3>
    <div id="history-list"></div>
    <div style="margin-top: 20px;">
        <label>
            <input type="checkbox" id="instant-lookup-toggle" checked onchange="toggleInstantLookup(this.checked)">
            Bật tra từ ngay khi nhấn
        </label>
        <button onclick="translateAllVocab()">Dịch tất cả từ vựng bằng Google Dịch</button>
    </div>
    <h3>Danh sách từ vựng đã tra</h3>
    <h3>Danh sách từ NotebookLM</h3>
    <textarea id="notebooklm-vocab" rows="10" placeholder="Dán danh sách từ ở đây..."></textarea>
    <button onclick="linkVocabToSubtitles()">Liên kết từ vựng với phụ đề</button>
    <div id="linked-vocab-list"></div>
    <div style="margin-bottom: 10px;">
        <label>
            <input type="checkbox" id="naver-lookup-toggle" onchange="toggleNaverLookup(this.checked)">
            Bật tra từ trên Naver
        </label>
    </div>
    <div id="vocab-list"></div>
    <h3>Phụ đề yêu thích</h3>
    <button onclick="clearAllFavorites()">Xóa tất cả phụ đề yêu thích</button>
    <div id="favorite-subtitles"></div>

    <script>
        let youtubePlayer;
        let subtitleData = [];
        let currentSubtitleIndex = -1;
        let isSpeaking = false;
        let ttsSpeed = 1.5;
        let ttsLanguage = "vi-VN";
        let history = [];
        let currentVideoUrl = "";
        let vocabList = [];
        let instantLookupEnabled = true;
        let naverLookupEnabled = false;
        let ttsVolume = 1.0;
        let syncInterval;
        let lastSpokenText = "";
        let lastSpokenTime = 0;
        let lastCheckedTime = 0;
        let isManualSeeking = false;
        let isRepeating = false;
        let repeatCount = 0;
        const maxRepeatCount = 3;
        let subtitleOffset = 0;
        let currentVideoFavorites = [];
        let vocabWarningEnabled = false;
        let vocabWarningTime = 5;
        let upcomingVocabCheckInterval;
        let autoPauseEnabled = false;
        let lastUpcomingVocab = [];

        function findBestSubtitleIndex(vocabWord) {
            const cleanVocab = vocabWord.replace(/[^\p{Script=Hangul}]+/gu, "").trim().substring(0, 2);
            if (cleanVocab.length < 2) return -1;
            
            for (let i = 0; i < subtitleData.length; i++) {
                const subtitleText = subtitleData[i].koreanText;
                const wordsInSubtitle = subtitleText.split(/\s+/);
                for (let word of wordsInSubtitle) {
                    const cleanWord = word.replace(/[^\p{Script=Hangul}]+/gu, "").trim();
                    if (cleanWord.length >= 2 && cleanWord.substring(0, 2) === cleanVocab) {
                        return i;
                    }
                }
            }
            return -1;
        }

        function linkVocabToSubtitles() {
            const vocabText = document.getElementById("notebooklm-vocab").value;
            const vocabArray = vocabText
                .split("\n")
                .map(v => {
                    const match = v.match(/[\p{Script=Hangul}]+(?:\s+[\p{Script=Hangul}]+)*/gu);
                    const korean = match ? match[0].trim() : "";
                    const meaningMatch = v.split(":").slice(1).join(":").trim();
                    const meaning = meaningMatch ? meaningMatch : "";
                    return korean ? { korean, meaning } : null;
                })
                .filter(v => v);
            const container = document.getElementById("linked-vocab-list");
            container.innerHTML = "";

            vocabArray.forEach(word => {
                const div = document.createElement("div");
                div.textContent = `${word.korean} ${word.meaning ? `- ${word.meaning}` : ""}`;
                div.className = "clickable-vocab";

                div.onclick = () => {
                    const matchIndex = findBestSubtitleIndex(word.korean);
                    if (matchIndex !== -1) {
                        youtubePlayer.seekTo(subtitleData[matchIndex].startTime, true);
                        youtubePlayer.playVideo();
                        highlightSubtitle(matchIndex);
                    } else {
                        alert("Không tìm thấy từ gần giống trong phụ đề");
                    }
                };
                container.appendChild(div);
            });
            saveToHistory(currentVideoUrl, null, vocabText);
        }

        function checkManualSeek() {
            if (!youtubePlayer) return;
            const currentTime = youtubePlayer.getCurrentTime();
            const timeDiff = Math.abs(currentTime - lastCheckedTime);
            if (timeDiff > 1 && timeDiff < 10) {
                isManualSeeking = true;
                handleManualSeek(currentTime);
            }
            lastCheckedTime = currentTime;
        }

        function handleManualSeek(currentTime) {
            if (!subtitleData.length) return;
            let newIndex = -1;
            for (let i = 0; i < subtitleData.length; i++) {
                if (subtitleData[i].startTime <= currentTime) {
                    newIndex = i;
                } else {
                    break;
                }
            }
            if (newIndex >= 0 && newIndex !== currentSubtitleIndex) {
                currentSubtitleIndex = newIndex;
                updateSubtitleDisplay(newIndex);
                if (isSpeaking) {
                    const textToRead = ttsLanguage === "vi-VN" ? subtitleData[newIndex].vietnameseText : subtitleData[newIndex].koreanText;
                    speechSynthesis.cancel();
                    readText(textToRead, () => { isSpeaking = false; });
                }
            }
            isManualSeeking = false;
        }

        function waitForPlayer() {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                const checkPlayer = () => {
                    if (youtubePlayer && youtubePlayer.seekTo && youtubePlayer.setVolume) {
                        resolve();
                    } else if (Date.now() - startTime > 10000) {
                        reject(new Error("YouTube player failed to initialize"));
                    } else {
                        setTimeout(checkPlayer, 100);
                    }
                };
                checkPlayer();
            });
        }

        function waitForVoices() {
            return new Promise((resolve) => {
                if (speechSynthesis.getVoices().length > 0) {
                    resolve();
                } else {
                    speechSynthesis.onvoiceschanged = () => {
                        speechSynthesis.onvoiceschanged = null;
                        resolve();
                    };
                }
            });
        }

        function loadVideo() {
            const urlInput = document.getElementById("video-url").value;
            const videoId = extractVideoId(urlInput);
            if (!videoId) {
                alert("URL không hợp lệ! Vui lòng nhập link dạng https://www.youtube.com/watch?v=dQw4w9WgXcQ");
                return;
            }
            currentVideoUrl = urlInput;
            const iframe = document.getElementById("youtube-video");
            iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1`;
            const subtitleLinkContainer = document.getElementById("subtitle-link-container");
            const subtitleLink = document.getElementById("subtitle-link");
            subtitleLink.href = `https://subtitle.to/${urlInput}`;
            subtitleLink.textContent = `Tải phụ đề từ subtitle.to cho video này`;
            subtitleLinkContainer.style.display = "block";
            initializePlayer();
            const historyItem = history.find(item => item.videoUrl === urlInput);
            vocabList = historyItem && historyItem.vocabList ? historyItem.vocabList.slice() : [];
            currentVideoFavorites = historyItem && historyItem.favoriteSubtitles ? historyItem.favoriteSubtitles.slice() : [];
            document.getElementById("notebooklm-vocab").value = historyItem && historyItem.notebooklmVocab ? historyItem.notebooklmVocab : "";
            saveToHistory(urlInput, null, document.getElementById("notebooklm-vocab").value);
            displayVocabList();
            displayFavorites();
            instantLookupEnabled = localStorage.getItem("instantLookup") === "1";
            document.getElementById("instant-lookup-toggle").checked = instantLookupEnabled;
        }

        async function loadAutoSubtitles() {
            alert("Đang thử tải phụ đề tự động từ subtitle.to...");
            try {
                const response = await new Promise(resolve => {
                    setTimeout(() => resolve({ text: `1\n00:00:01,000 --> 00:00:03,000\n안녕하세요\nXin chào\n\n2\n00:00:03,001 --> 00:00:05,000\n만나서 반갑습니다\nRất vui được gặp bạn` }), 1000);
                });
                subtitleData = parseSRT(response.text);
                if (subtitleData.length === 0) {
                    alert("Không tải được phụ đề!");
                    return;
                }
                alert(`Đã tải ${subtitleData.length} dòng phụ đề tự động!`);
                displaySubtitleList();
                saveToHistory(currentVideoUrl, response.text, document.getElementById("notebooklm-vocab").value);
            } catch (error) {
                console.error("Lỗi tải phụ đề tự động:", error);
                alert("Lỗi khi tải phụ đề tự động: " + error.message);
            }
        }

        function extractVideoId(url) {
            const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=))([^?&]+)/);
            return match ? match[1] : null;
        }

        function initializePlayer() {
            youtubePlayer = new YT.Player("youtube-video", {
                events: {
                    onReady: () => {
                        setInterval(checkManualSeek, 1000);
                        console.log("Video đã sẵn sàng");
                        updateVideoVolume(document.getElementById("video-volume").value);
                    },
                    onStateChange: (event) => {
                        if (event.data === YT.PlayerState.PLAYING) {
                            startReading();
                        } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                            stopReading();
                        }
                    }
                }
            });
        }

        function updateVideoVolume(value) {
            if (youtubePlayer && youtubePlayer.setVolume) {
                youtubePlayer.setVolume(parseInt(value));
                document.getElementById("video-volume-value").textContent = value;
            }
        }

        function updateTTSVolume(value) {
            ttsVolume = parseFloat(value);
            document.getElementById("tts-volume-value").textContent = ttsVolume.toFixed(1);
            localStorage.setItem("ttsVolume", ttsVolume);
        }

        function updateTTSLanguage(language) {
            ttsLanguage = language;
            localStorage.setItem("ttsLanguage", ttsLanguage);
        }

        function updateSubtitleOffset(value) {
            const newOffset = parseFloat(value) || 0;
            if (Math.abs(newOffset - subtitleOffset) > 0.05) {
                subtitleOffset = newOffset;
                document.getElementById("offset-value").textContent = subtitleOffset.toFixed(1);
                localStorage.setItem("subtitleOffset", subtitleOffset);
                if (syncInterval) {
                    clearInterval(syncInterval);
                    syncInterval = setInterval(syncSubtitles, 300);
                    syncSubtitles();
                }
            }
        }

        function toggleNegativeOffset() {
            const input = document.getElementById("subtitle-offset");
            let value = parseFloat(input.value);
            if (value > 0) {
                value = -value;
            } else if (value < 0) {
                value = Math.abs(value);
            } else {
                value = -0.1;
            }
            input.value = value.toFixed(1);
            updateSubtitleOffset(input.value);
        }

        function applyOffsetToSubtitles() {
            const offset = parseFloat(document.getElementById("subtitle-offset").value) || 0;
            if (!subtitleData.length) {
                alert("Chưa có phụ đề để chỉnh thời gian.");
                return;
            }

            subtitleData.forEach(sub => {
                sub.startTime = Math.max(0, sub.startTime + offset);
                sub.endTime = Math.max(0, sub.endTime + offset);
            });
            subtitleOffset = 0;
            document.getElementById("subtitle-offset").value = "0";
            document.getElementById("offset-value").textContent = "0.0";
            localStorage.setItem("subtitleOffset", "0");

            displaySubtitleList();
            alert(`Đã áp dụng lệch ${offset} giây vĩnh viễn cho toàn bộ phụ đề.`);
        }

        function loadSubtitles() {
            const fileInput = document.getElementById("subtitle-file").files[0];
            if (!fileInput) {
                alert("Vui lòng chọn file SRT!");
                return;
            }
            const reader = new FileReader();
            reader.onload = (event) => {
                subtitleData = parseSRT(event.target.result);
                if (subtitleData.length === 0) {
                    alert("File SRT không hợp lệ hoặc trống!");
                    return;
                }
                alert(`Đã tải ${subtitleData.length} dòng phụ đề!`);
                displaySubtitleList();
                saveToHistory(currentVideoUrl, event.target.result, document.getElementById("notebooklm-vocab").value);
            };
            reader.readAsText(fileInput);
        }

        function parseSRT(srtContent) {
            const subtitleBlocks = srtContent.trim().split(/\n\s*\n/);
            return subtitleBlocks.map(block => {
                const lines = block.split("\n");
                if (lines.length < 3) return null;

                const timing = lines[1].split(" --> ");
                const startTimeParts = timing[0].split(/[:,]/);
                const endTimeParts = timing[1].split(/[:,]/);
                const startTime = parseInt(startTimeParts[0]) * 3600 + parseInt(startTimeParts[1]) * 60 + parseFloat(`${startTimeParts[2]}.${startTimeParts[3] || '0'}`);
                const endTime = parseInt(endTimeParts[0]) * 3600 + parseInt(endTimeParts[1]) * 60 + parseFloat(`${endTimeParts[2]}.${endTimeParts[3] || '0'}`);

                if (lines.length === 3) {
                    const koreanText = lines[2].trim();
                    return { 
                        startTime: isNaN(startTime) ? 0 : startTime,
                        endTime: isNaN(endTime) ? startTime + 2 : endTime,
                        fullText: koreanText, 
                        koreanText, 
                        vietnameseText: ""
                    };
                } else {
                    const koreanText = lines[2].trim();
                    const vietnameseText = lines[3].trim();
                    return { 
                        startTime: isNaN(startTime) ? 0 : startTime,
                        endTime: isNaN(endTime) ? startTime + 2 : endTime,
                        fullText: `${koreanText} ${vietnameseText}`, 
                        koreanText, 
                        vietnameseText 
                    };
                }
            }).filter(item => item && typeof item.startTime === 'number' && item.koreanText);
        }

        async function translateSRT() {
            if (!subtitleData.length) {
                alert("Vui lòng tải phụ đề trước!");
                return;
            }
            
            const hasVietnamese = subtitleData.some(sub => sub.vietnameseText && sub.vietnameseText.trim() !== "");
            if (hasVietnamese) {
                alert("Phụ đề đã có bản dịch tiếng Việt!");
                return;
            }
            
            if (!confirm(`Bạn có chắc muốn dịch ${subtitleData.length} dòng phụ đề sang tiếng Việt? Quá trình này có thể mất khoảng ${Math.ceil(subtitleData.length * 0.5 / 60)} phút.`)) {
                return;
            }
            
            try {
                const wasPlaying = youtubePlayer && youtubePlayer.getPlayerState() === YT.PlayerState.PLAYING;
                if (wasPlaying) {
                    youtubePlayer.pauseVideo();
                }
                
                document.getElementById("translation-progress").style.display = "block";
                for (let i = 0; i < subtitleData.length; i++) {
                    const sub = subtitleData[i];
                    const progress = Math.floor((i / subtitleData.length) * 100);
                    document.getElementById("progress-bar").value = progress;
                    document.getElementById("progress-text").textContent = `Đang dịch... ${progress}%`;
                    
                    sub.vietnameseText = await translateText(sub.koreanText);
                    sub.fullText = `${sub.koreanText} ${sub.vietnameseText}`;
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                document.getElementById("translation-progress").style.display = "none";
                alert(`Đã dịch xong ${subtitleData.length} dòng phụ đề!`);
                displaySubtitleList();
                saveToHistory(currentVideoUrl, convertToSRT(subtitleData), document.getElementById("notebooklm-vocab").value);
                if (wasPlaying) {
                    youtubePlayer.playVideo();
                }
            } catch (error) {
                console.error("Lỗi khi dịch phụ đề:", error);
                document.getElementById("translation-progress").style.display = "none";
                alert("Lỗi khi dịch phụ đề: " + error.message);
            }
        }

        async function translateText(text) {
            try {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=vi&dt=t&q=${encodeURIComponent(text)}`;
                const res = await fetch(url);
                const data = await res.json();
                return data[0].map(x => x[0]).join('');
            } catch (e) {
                console.error("Lỗi dịch Google:", e);
                return "[Lỗi dịch]";
            }
        }

        function convertToSRT(subtitles) {
            let srtContent = "";
            subtitles.forEach((sub, index) => {
                const startTime = formatTimeForSRT(sub.startTime);
                const endTime = formatTimeForSRT(sub.endTime || sub.startTime + 2);
                
                srtContent += `${index + 1}\n`;
                srtContent += `${startTime} --> ${endTime}\n`;
                srtContent += `${sub.koreanText}\n`;
                srtContent += `${sub.vietnameseText || ''}\n\n`;
            });
            return srtContent;
        }

        function formatTimeForSRT(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')},${ms.toString().padStart(3, '0')}`;
        }

        function displaySubtitleList() {
            const subtitleList = document.getElementById("subtitle-list");
            subtitleList.innerHTML = "";
            subtitleData.forEach((sub, index) => {
                const div = document.createElement("div");
                div.className = "subtitle-item";
                div.innerHTML = `${formatTime(sub.startTime)}: <span class="korean">${sub.koreanText}</span> <span class="vietnamese">${sub.vietnameseText}</span> <button onclick="addFavoriteToCurrentVideo(${index}); event.stopPropagation();">Yêu thích</button>`;
                div.onclick = () => jumpToSubtitle(index);
                subtitleList.appendChild(div);
            });
        }

        async function fetchGoogleTranslate(text) {
            try {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=vi&dt=t&q=${encodeURIComponent(text)}`;
                const res = await fetch(url);
                const data = await res.json();
                const translated = data[0].map(x => x[0]).join('');
                const index = vocabList.findIndex(item => item.word === text);
                if (index !== -1) {
                    vocabList[index].meaning = translated;
                    saveVocabToHistory();
                    displayVocabList();
                    updateSubtitleDisplay(currentSubtitleIndex);
                }
            } catch (e) {
                console.error("Lỗi dịch Google:", e);
            }
        }

        async function translateAllVocab() {
            for (let item of vocabList) {
                if (!item.meaning || item.meaning === "Đang tra cứu...") {
                    await fetchGoogleTranslate(item.word);
                    await new Promise(r => setTimeout(r, 00));
                }
            }
            alert("Đã dịch xong tất cả từ vựng!");
        }

        function toggleInstantLookup(enabled) {
            instantLookupEnabled = enabled;
            localStorage.setItem("instantLookup", enabled ? "1" : "0");
        }
        
        function lookupWord(word) {
            const existing = vocabList.find(item => item.word === word);
            if (!existing) {
                vocabList.push({ word, meaning: "Đang tra cứu..." });
                saveVocabToHistory();
                displayVocabList();
            }

            if (instantLookupEnabled) {
                const naverUrl = `https://korean.dict.naver.com/kovidict/#/search?query=${encodeURIComponent(word)}`;
                window.open(naverUrl, "_blank");
                fetchGoogleTranslate(word);
            }
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, "0");
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, "0");
            const s = Math.floor(seconds % 60).toString().padStart(2, "0");
            return `${h}:${m}:${s}`;
        }

        function jumpToSubtitle(index) {
            if (!youtubePlayer) {
                alert("Vui lòng tải video trước!");
                return;
            }
            currentSubtitleIndex = index - 1;
            youtubePlayer.seekTo(subtitleData[index].startTime, true);
            youtubePlayer.playVideo();
            highlightSubtitle(index);
        }

        function highlightSubtitle(index) {
            const items = document.getElementsByClassName("subtitle-item");
            for (let i = 0; i < items.length; i++) {
                items[i].classList.remove("active");
            }
            if (items[index]) items[index].classList.add("active");
        }

        function updateTTSSpeed(value) {
            ttsSpeed = parseFloat(value);
            document.getElementById("speed-value").textContent = ttsSpeed;
            localStorage.setItem("ttsSpeed", ttsSpeed);
        }

        function startReading() {
            if (!youtubePlayer || subtitleData.length === 0) {
                alert("Vui lòng tải video và phụ đề trước!");
                return;
            }
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            syncInterval = setInterval(() => {
                syncSubtitles();
            }, 200);
            syncSubtitles();
        }

        function syncSubtitles() {
            if (!youtubePlayer || youtubePlayer.getPlayerState() !== YT.PlayerState.PLAYING) {
                return;
            }
            const currentTime = youtubePlayer.getCurrentTime() + subtitleOffset;
            let nextSubtitle = null;
            let nextIndex = -1;
            for (let i = 0; i < subtitleData.length; i++) {
                if (subtitleData[i].startTime <= currentTime) {
                    nextSubtitle = subtitleData[i];
                    nextIndex = i;
                } else {
                    break;
                }
            }
            if (nextSubtitle && nextIndex !== currentSubtitleIndex) {
                currentSubtitleIndex = nextIndex;
                updateSubtitleDisplay(currentSubtitleIndex);
                const textToRead = ttsLanguage === "vi-VN" ? nextSubtitle.vietnameseText : nextSubtitle.koreanText;
                const currentTimeMs = Date.now();
                if (textToRead !== lastSpokenText || (currentTimeMs - lastSpokenTime) > 1000) {
                    speechSynthesis.cancel();
                    isSpeaking = true;
                    readText(textToRead, () => {
                        isSpeaking = false;
                        if (isRepeating && repeatCount < maxRepeatCount) {
                            repeatCount++;
                            youtubePlayer.seekTo(nextSubtitle.startTime, true);
                        } else {
                            repeatCount = 0;
                        }
                    });
                    lastSpokenText = textToRead;
                    lastSpokenTime = currentTimeMs;
                }
            }
        }

        function updateSubtitleDisplay(index) {
            const startIndex = Math.max(0, index - 2);
            const endIndex = Math.min(subtitleData.length - 1, index + 2);
            let subtitleContent = "";
            const notebookVocab = document.getElementById("notebooklm-vocab").value
                .split("\n")
                .filter(line => line.trim())
                .map(line => line.split(":")[0]?.trim())
                .filter(korean => korean);

            for (let i = startIndex; i <= endIndex; i++) {
                const sub = subtitleData[i];
                const highlightedKoreanText = sub.koreanText.split(/\s+/).map(word => {
                    const cleanWord = word.replace(/[^\p{Script=Hangul}]+/gu, "").trim();
                    const isLearned = notebookVocab.some(v => v.includes(cleanWord) || cleanWord.includes(v));
                    if (isLearned) {
                        return `<span class="korean-word learned" onclick="lookupWord('${cleanWord}')">${word}</span>`;
                    }
                    return `<span class="korean-word" onclick="lookupWord('${cleanWord}')">${word}</span>`;
                }).join(" ");
                const isCurrent = i === index ? "current" : "";
                subtitleContent += `<div class="subtitle-line ${isCurrent}"> ${formatTime(sub.startTime)}: ${highlightedKoreanText} <span class="vietnamese">${sub.vietnameseText}</span> </div>`;
            }
            document.getElementById("subtitle-display").innerHTML = subtitleContent;
            highlightSubtitle(index);
        }

        function readText(text, callback) {
            if (!text) {
                callback?.();
                return;
            }
            try {
                if (typeof speechSynthesis === 'undefined' || !speechSynthesis) {
                    console.error("Trình duyệt không hỗ trợ Web Speech API");
                    alert("Trình duyệt của bạn không hỗ trợ chức năng đọc văn bản (TTS).");
                    callback?.();
                    return;
                }
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = ttsLanguage;
                utterance.rate = ttsSpeed;
                utterance.volume = ttsVolume;
                const voices = speechSynthesis.getVoices();
                if (!voices || voices.length === 0) {
                    console.error("Không tìm thấy giọng đọc nào");
                    alert("Không tìm thấy giọng đọc phù hợp. Vui lòng kiểm tra cài đặt ngôn ngữ trên thiết bị.");
                    callback?.();
                    return;
                }
                const preferredVoice = voices.find(voice => voice.lang === ttsLanguage);
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                } else {
                    console.warn("Không tìm thấy giọng đọc phù hợp với ngôn ngữ", ttsLanguage);
                }
                utterance.onend = () => {
                    callback?.();
                };
                utterance.onerror = (event) => {
                    console.error("Lỗi TTS:", event);
                    callback?.();
                };
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error("Lỗi khi đọc văn bản:", error);
                callback?.();
            }
        }

        function stopReading() {
            if (typeof speechSynthesis !== "undefined") {
                speechSynthesis.cancel();
                isSpeaking = false;
            }
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            isRepeating = false;
            repeatCount = 0;
        }

        function toggleRepeat() {
            isRepeating = !isRepeating;
            alert(isRepeating ? "Đã bật chế độ lặp phụ đề (3 lần)" : "Đã tắt chế độ lặp phụ đề");
        }

        function rewindSubtitle() {
            if (!youtubePlayer || subtitleData.length === 0) {
                alert("Vui lòng tải video và phụ đề trước!");
                return;
            }
            const currentTime = youtubePlayer.getCurrentTime();
            const rewindTime = Math.max(0, currentTime - 5);
            let newIndex = -1;
            for (let i = subtitleData.length - 1; i >= 0; i--) {
                if (subtitleData[i].startTime <= rewindTime) {
                    newIndex = i;
                    break;
                }
            }
            if (newIndex >= 0) {
                youtubePlayer.seekTo(rewindTime, true);
                currentSubtitleIndex = newIndex - 1;
                updateSubtitleDisplay(newIndex);
                if (youtubePlayer.getPlayerState() !== YT.PlayerState.PLAYING) {
                    youtubePlayer.playVideo();
                }
            }
        }

        function saveToHistory(videoUrl, srtContent, notebooklmVocab) {
            currentVideoUrl = videoUrl;
            const existingIndex = history.findIndex(item => item.videoUrl === videoUrl);
            const currentVocab = vocabList.slice();
            const currentFavorites = currentVideoFavorites.slice();
            if (existingIndex !== -1) {
                history[existingIndex].srtContent = srtContent || history[existingIndex].srtContent;
                history[existingIndex].vocabList = currentVocab;
                history[existingIndex].notebooklmVocab = notebooklmVocab || history[existingIndex].notebooklmVocab;
                history[existingIndex].favoriteSubtitles = currentFavorites;
            } else {
                history.push({ 
                    videoUrl, 
                    srtContent, 
                    vocabList: currentVocab, 
                    notebooklmVocab: notebooklmVocab,
                    favoriteSubtitles: currentFavorites
                });
            }
            localStorage.setItem("videoHistory", JSON.stringify(history));
            displayHistory();
        }

        function displayHistory() {
            const historyList = document.getElementById("history-list");
            historyList.innerHTML = "";
            history.forEach((item, index) => {
                const div = document.createElement("div");
                div.className = "history-item";
                div.innerHTML = ` ${item.videoUrl} ${item.srtContent ? "(Có phụ đề)" : ""} ${item.vocabList && item.vocabList.length > 0 ? `(${item.vocabList.length} từ vựng)` : ""} <button onclick="deleteHistoryItem(${index})">Xóa</button> `;
                div.onclick = (e) => {
                    if (e.target.tagName !== "BUTTON") loadFromHistory(index);
                };
                historyList.appendChild(div);
            });
        }

        async function loadFromHistory(index) {
            const item = history[index];
            if (!item) return;
            document.getElementById("video-url").value = item.videoUrl;
            currentVideoUrl = item.videoUrl;
            
            loadVideo();
            try {
                await Promise.all([waitForPlayer(), waitForVoices()]);
                if (item.srtContent) {
                    subtitleData = parseSRT(item.srtContent);
                    displaySubtitleList();
                } else {
                    subtitleData = [];
                    document.getElementById("subtitle-list").innerHTML = "";
                    document.getElementById("subtitle-display").innerHTML = "";
                }
                
                vocabList = item.vocabList ? item.vocabList.slice() : [];
                document.getElementById("notebooklm-vocab").value = item.notebooklmVocab || "";
                currentVideoFavorites = item.favoriteSubtitles ? item.favoriteSubtitles.slice() : [];
                displayVocabList();
                linkVocabToSubtitles();
                displayFavorites();
                
                instantLookupEnabled = localStorage.getItem("instantLookup") === "1";
                document.getElementById("instant-lookup-toggle").checked = instantLookupEnabled;
                if (ttsVolume === 0) {
                    alert("Âm lượng TTS hiện bằng 0. Vui lòng điều chỉnh thanh trượt âm lượng TTS.");
                }
                if (youtubePlayer && youtubePlayer.playVideo) {
                    youtubePlayer.playVideo();
                    setTimeout(startReading, 1000);
                }
            } catch (error) {
                console.error("Lỗi khi tải lịch sử:", error);
                alert("Có lỗi xảy ra khi tải lịch sử: " + error.message);
            }
        }

        function deleteHistoryItem(index) {
            history.splice(index, 1);
            localStorage.setItem("videoHistory", JSON.stringify(history));
            displayHistory();
            displayFavorites();
        }

        function toggleNaverLookup(enabled) {
            naverLookupEnabled = enabled;
            localStorage.setItem("naverLookup", enabled ? "1" : "0");
            displayVocabList();
        }

        function openNaverDict(word) {
            window.open(`https://korean.dict.naver.com/kovidict/#/search?query=${encodeURIComponent(word)}`, "_blank");
        }

        function displayVocabList() {
            const vocabListDiv = document.getElementById("vocab-list");
            vocabListDiv.innerHTML = "";
            vocabList.forEach((item, index) => {
                const div = document.createElement("div");
                div.className = "vocab-item";
                if (naverLookupEnabled) {
                    div.className = "vocab-item-naver";
                    div.innerHTML = `<div> <span class="korean-word clickable" onclick="openNaverDict('${item.word}')">${item.word}</span> <span class="vietnamese translation">${item.meaning}</span> </div> <button onclick="deleteVocab(${index})">Xóa</button> `;
                } else {
                    div.innerHTML = ` <input type="text" value="${item.word}" onchange="editVocab(${index}, 'word', this.value)"> <input type="text" value="${item.meaning}" placeholder="Nhập nghĩa..." onchange="editVocab(${index}, 'meaning', this.value)"> <button onclick="deleteVocab(${index})">Xóa</button> `;
                }
                vocabListDiv.appendChild(div);
            });
        }

        function editVocab(index, field, value) {
            vocabList[index][field] = value;
            saveVocabToHistory();
        }

        function deleteVocab(index) {
            vocabList.splice(index, 1);
            saveVocabToHistory();
            displayVocabList();
        }

        function saveVocabToHistory() {
            const existingIndex = history.findIndex(item => item.videoUrl === currentVideoUrl);
            if (existingIndex !== -1) {
                history[existingIndex].vocabList = vocabList.slice();
                history[existingIndex].notebooklmVocab = document.getElementById("notebooklm-vocab").value;
                history[existingIndex].favoriteSubtitles = currentVideoFavorites.slice();
                localStorage.setItem("videoHistory", JSON.stringify(history));
            }
        }

        function addFavoriteToCurrentVideo(index) {
            const sub = subtitleData[index];
            if (!sub) return;
            const existing = currentVideoFavorites.find(item => item.koreanText === sub.koreanText && item.vietnameseText === sub.vietnameseText);
            if (!existing) {
                currentVideoFavorites.push(sub);
                saveVocabToHistory();
                displayFavorites();
                alert("Đã thêm vào phụ đề yêu thích!");
            } else {
                alert("Phụ đề này đã có trong danh sách yêu thích của video này.");
            }
        }

        function removeFavorite(index) {
            currentVideoFavorites.splice(index, 1);
            saveVocabToHistory();
            displayFavorites();
        }
        
        function displayFavorites() {
            const favoriteList = document.getElementById("favorite-subtitles");
            favoriteList.innerHTML = "";
            currentVideoFavorites.forEach((sub, index) => {
                const div = document.createElement("div");
                div.className = "subtitle-item";
                div.innerHTML = `<span class="korean">${sub.koreanText}</span> <span class="vietnamese">${sub.vietnameseText}</span> <button onclick="removeFavorite(${index}); event.stopPropagation();">Xóa</button>`;
                div.onclick = () => jumpToSubtitleByText(sub.koreanText);
                favoriteList.appendChild(div);
            });
        }
        
        function clearAllFavorites() {
            if (confirm("Bạn có chắc chắn muốn xóa toàn bộ phụ đề yêu thích của video hiện tại?")) {
                currentVideoFavorites = [];
                saveVocabToHistory();
                displayFavorites();
            }
        }

        function jumpToSubtitleByText(text) {
            const index = subtitleData.findIndex(sub => sub.koreanText === text);
            if (index !== -1) {
                jumpToSubtitle(index);
            } else {
                alert("Không tìm thấy phụ đề tương ứng trong video hiện tại.");
            }
        }

        function saveState() {
            const state = {
                history: history,
                ttsSpeed: ttsSpeed,
                ttsLanguage: ttsLanguage,
                ttsVolume: ttsVolume,
                instantLookupEnabled: instantLookupEnabled,
                naverLookupEnabled: naverLookupEnabled,
                subtitleOffset: subtitleOffset,
                vocabWarningEnabled: vocabWarningEnabled,
                vocabWarningTime: vocabWarningTime,
                autoPauseEnabled: autoPauseEnabled
            };
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `youtube_state_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert("Đã lưu trạng thái!");
        }

        function loadState() {
            const fileInput = document.getElementById("state-file").files[0];
            if (!fileInput) {
                alert("Vui lòng chọn file JSON để tải!");
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const state = JSON.parse(event.target.result);
                    history = state.history || [];
                    ttsSpeed = state.ttsSpeed || 1.5;
                    ttsLanguage = state.ttsLanguage || "vi-VN";
                    ttsVolume = state.ttsVolume || 1.0;
                    instantLookupEnabled = state.instantLookupEnabled ?? true;
                    naverLookupEnabled = state.naverLookupEnabled ?? false;
                    subtitleOffset = state.subtitleOffset ?? 0;
                    vocabWarningEnabled = state.vocabWarningEnabled ?? false;
                    vocabWarningTime = state.vocabWarningTime ?? 5;
                    autoPauseEnabled = state.autoPauseEnabled ?? false;

                    localStorage.setItem("videoHistory", JSON.stringify(history));
                    localStorage.setItem("ttsSpeed", ttsSpeed);
                    localStorage.setItem("ttsLanguage", ttsLanguage);
                    localStorage.setItem("ttsVolume", ttsVolume);
                    localStorage.setItem("instantLookup", instantLookupEnabled ? "1" : "0");
                    localStorage.setItem("naverLookup", naverLookupEnabled ? "1" : "0");
                    localStorage.setItem("subtitleOffset", subtitleOffset);
                    localStorage.setItem("vocabWarningEnabled", vocabWarningEnabled ? "true" : "false");
                    localStorage.setItem("vocabWarningTime", vocabWarningTime);
                    localStorage.setItem("autoPauseEnabled", autoPauseEnabled ? "true" : "false");

                    document.getElementById("tts-speed").value = ttsSpeed;
                    document.getElementById("speed-value").textContent = ttsSpeed;
                    document.getElementById("tts-language").value = ttsLanguage;
                    document.getElementById("tts-volume").value = ttsVolume;
                    document.getElementById("video-volume").value = ttsVolume * 100;
                    document.getElementById("video-volume-value").textContent = ttsVolume * 100;
                    document.getElementById("instant-lookup-toggle").checked = instantLookupEnabled;
                    document.getElementById("naver-lookup-toggle").checked = naverLookupEnabled;
                    document.getElementById("subtitle-offset").value = subtitleOffset;
                    document.getElementById("offset-value").textContent = subtitleOffset.toFixed(1);
                    document.getElementById("vocab-warning-time").value = vocabWarningTime;
                    document.getElementById("auto-pause-button").textContent = `Tạm dừng tự động (${autoPauseEnabled ? "Bật" : "Tắt"})`;

                    displayHistory();
                    alert("Đã tải trạng thái thành công!");
                } catch (e) {
                    console.error("Lỗi khi đọc file JSON:", e);
                    alert("File không hợp lệ!");
                }
            };
            reader.readAsText(fileInput);
        }
        
        function toggleVocabWarning() {
            vocabWarningEnabled = !vocabWarningEnabled;
            localStorage.setItem("vocabWarningEnabled", vocabWarningEnabled);

            if (vocabWarningEnabled) {
                document.getElementById("vocab-warning-time").addEventListener('change', function() {
                    vocabWarningTime = parseInt(this.value) || 5;
                    localStorage.setItem("vocabWarningTime", vocabWarningTime);
                });
                vocabWarningTime = parseInt(document.getElementById("vocab-warning-time").value) || 5;
                startUpcomingVocabCheck();
                alert("Đã bật cảnh báo từ vựng sắp xuất hiện (" + vocabWarningTime + " giây)");
            } else {
                stopUpcomingVocabCheck();
                document.getElementById("upcoming-vocab-display").innerHTML = "";
                alert("Đã tắt cảnh báo từ vựng sắp xuất hiện");
            }
        }
        
        function toggleAutoPause() {
            autoPauseEnabled = !autoPauseEnabled;
            const button = document.getElementById("auto-pause-button");
            button.textContent = `Tạm dừng tự động (${autoPauseEnabled ? "Bật" : "Tắt"})`;
            localStorage.setItem("autoPauseEnabled", autoPauseEnabled);
            if (!autoPauseEnabled) {
                if (youtubePlayer && youtubePlayer.getPlayerState() === YT.PlayerState.PAUSED) {
                    youtubePlayer.playVideo();
                }
            }
        }

        function startUpcomingVocabCheck() {
            if (upcomingVocabCheckInterval) clearInterval(upcomingVocabCheckInterval);
            upcomingVocabCheckInterval = setInterval(checkUpcomingVocab, 500);
        }

        function stopUpcomingVocabCheck() {
            if (upcomingVocabCheckInterval) clearInterval(upcomingVocabCheckInterval);
            upcomingVocabCheckInterval = null;
        }

        function checkUpcomingVocab() {
            if (!vocabWarningEnabled || !youtubePlayer || !subtitleData.length) return;
            
            const currentTime = youtubePlayer.getCurrentTime();
            const warningTime = currentTime + vocabWarningTime;
            
            const notebookVocab = document.getElementById("notebooklm-vocab").value
                .split("\n")
                .filter(line => line.trim())
                .map(line => {
                    const parts = line.split(":");
                    return {
                        korean: parts[0]?.trim() || "",
                        meaning: parts.slice(1).join(":").trim() || ""
                    };
                })
                .filter(item => item.korean);
            
            let currentUpcomingVocab = [];
            
            for (let i = 0; i < subtitleData.length; i++) {
                const sub = subtitleData[i];
                if (sub.startTime > currentTime && sub.startTime <= warningTime) {
                    const wordsInSubtitle = sub.koreanText.split(/\s+/);
                    
                    wordsInSubtitle.forEach(word => {
                        const cleanWord = word.replace(/[^\p{Script=Hangul}]+/gu, "").trim();
                        if (cleanWord.length < 2) return;
                        
                        const vocabMatch = notebookVocab.find(v => 
                            v.korean.includes(cleanWord) || cleanWord.includes(v.korean)
                        );
                        
                        if (vocabMatch && !currentUpcomingVocab.some(v => v.korean === vocabMatch.korean)) {
                            currentUpcomingVocab.push({
                                korean: vocabMatch.korean,
                                meaning: vocabMatch.meaning,
                                appearTime: sub.startTime,
                                subtitleIndex: i
                            });

                            if (autoPauseEnabled) {
                                const pauseTime = sub.startTime - 1;
                                if (currentTime >= pauseTime && youtubePlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                                    youtubePlayer.pauseVideo();
                                }
                            }
                        }
                    });
                }
            }
            
            if (JSON.stringify(currentUpcomingVocab) !== JSON.stringify(lastUpcomingVocab)) {
                displayUpcomingVocab(currentUpcomingVocab);
                lastUpcomingVocab = currentUpcomingVocab;
            }
        }

        function displayUpcomingVocab(vocabList) {
            const container = document.getElementById("upcoming-vocab-display");
            container.innerHTML = "";
            
            if (vocabList.length === 0) {
                container.innerHTML = "<p>Không có từ vựng nào sắp xuất hiện trong " + vocabWarningTime + " giây tới</p>";
                return;
            }
            
            vocabList.sort((a, b) => a.appearTime - b.appearTime);
            
            vocabList.forEach(item => {
                const vocabDiv = document.createElement("div");
                vocabDiv.className = "upcoming-vocab-item";
                vocabDiv.innerHTML = `
                    <div>
                        <span class="upcoming-vocab-korean">${item.korean}</span>
                        <span class="upcoming-vocab-meaning">${item.meaning}</span>
                        <span class="upcoming-vocab-time">(xuất hiện sau ${(item.appearTime - youtubePlayer.getCurrentTime()).toFixed(1)}s)</span>
                    </div>
                    <button onclick="jumpToSubtitle(${item.subtitleIndex})">Xem</button>
                `;
                container.appendChild(vocabDiv);
            });
        }

        function loadInitialState() {
            try {
                history = JSON.parse(localStorage.getItem("videoHistory")) || [];
                ttsSpeed = parseFloat(localStorage.getItem("ttsSpeed")) || 1.5;
                ttsLanguage = localStorage.getItem("ttsLanguage") || "vi-VN";
                ttsVolume = parseFloat(localStorage.getItem("ttsVolume")) || 1.0;
                instantLookupEnabled = localStorage.getItem("instantLookup") !== "0";
                naverLookupEnabled = localStorage.getItem("naverLookup") === "1";
                subtitleOffset = parseFloat(localStorage.getItem("subtitleOffset")) || 0;
                vocabWarningEnabled = localStorage.getItem("vocabWarningEnabled") === "true";
                vocabWarningTime = parseInt(localStorage.getItem("vocabWarningTime")) || 5;
                autoPauseEnabled = localStorage.getItem("autoPauseEnabled") === "true";

                document.getElementById("tts-speed").value = ttsSpeed;
                document.getElementById("speed-value").textContent = ttsSpeed;
                document.getElementById("tts-language").value = ttsLanguage;
                document.getElementById("tts-volume").value = ttsVolume;
                document.getElementById("video-volume").value = ttsVolume * 100;
                document.getElementById("video-volume-value").textContent = ttsVolume * 100;
                document.getElementById("instant-lookup-toggle").checked = instantLookupEnabled;
                document.getElementById("naver-lookup-toggle").checked = naverLookupEnabled;
                document.getElementById("subtitle-offset").value = subtitleOffset;
                document.getElementById("offset-value").textContent = subtitleOffset.toFixed(1);
                document.getElementById("vocab-warning-time").value = vocabWarningTime;
                document.getElementById("auto-pause-button").textContent = `Tạm dừng tự động (${autoPauseEnabled ? "Bật" : "Tắt"})`;

                displayHistory();

                if (vocabWarningEnabled) {
                    toggleVocabWarning();
                }
            } catch (e) {
                console.error("Lỗi khi tải trạng thái ban đầu:", e);
            }
        }

        window.onload = loadInitialState;
    </script>
</body>
</html>
